[ { "title": "WSL2から見たWindows側フォルダの所有者がおかしかった", "url": "/doc/posts/wsl-filepermission/", "categories": "WSL", "tags": "WSL, Linux, Ubuntu, Windows, WSL2", "date": "2021-12-22 00:00:00 +0900", "snippet": "WSL2 (Windows Subsystem for Linux) の Ubuntu環境をインストール後、dockerコマンドを実行した時にパーミッション関連でエラーが発生した。結論WSL2 を再起動したら直った。状況/mnt/c/Users/togino77/work ディレクトリ内で ls -al したところ、本来 togino77 が所有者であるのに root が所有者になっているディレクトリがある。togino77@machine:/mnt/c/Users/togino77/work $ ls -al...略...drwxr-xr-x 1 root root 4096 Dec 21 17:36 _posts...略...やってみたことWindows側で、 C:\\Users\\togino77\\work\\_posts のプロパティにあるセキュリティを確認したが、詳細設定で所有者を見ても togino77 になっており、正常である。chmod コマンドで所有者を変更してみるが、変化しない。（コマンドエラーにもならない）togino77@machine:/mnt/c/Users/togino77/work $ chmod togino77:togino77 _posts解決Windows側の Terminal にて Powershell を開き、下記コマンドを実行して、Ubuntu 環境に再接続したら直った。PS C:\\Users\\togino77&amp;gt; wsl --shutdownおまけWSL のファイルパーミッションについてhttps://docs.microsoft.com/ja-jp/windows/wsl/file-permissions" }, { "title": "Test Post", "url": "/doc/posts/test/", "categories": "Test", "tags": "Test", "date": "2021-12-22 00:00:00 +0900", "snippet": "これはテスト投稿ですよ" }, { "title": "Feathers のソースコードを読んでみる。application 編", "url": "/doc/posts/feathersjs-application/", "categories": "Featchers", "tags": "Featchers, JavaScript", "date": "2021-12-21 00:00:00 +0900", "snippet": "Application インスタンスは、サービスやフック、プラグインの設定やオプション設定を管理し、初期設定されたアプリケーションは app object として参照される。最小限の app object は以下のようにして用意することができる。const feathers = require(&#39;@feathersjs/feathers&#39;);const app = feathers();今回は、この app が生成されるまでのソースコードを読んでみる。流れソースコードconst feathers = require(&#39;@feathersjs/feathers&#39;)この require により feathers/lib/index.js でデフォルトエクスポートされる関数を定数 feathers に代入する$ less feathers/lib/index.jsconst Proto = require(&#39;uberproto&#39;);const Application = require(&#39;./application&#39;);const baseObject = Object.create(null);function createApplication () { const app = Object.create(baseObject); // Mix in the base application Proto.mixin(Application, app); app.init(); return app;}module.exports = createApplication;つまり、feathers は createApplication 関数であり、これは app object を返すものである。app オブジェクトは Object.create() で生成された空のオブジェクトに Application を mixin し mixin された init() を呼び出して初期化したものといえる。ちなみに、最初に生成された空のオブジェクトというのは、Object.create(null) で生成されたものをプロトタイプとして Object.craete したものなので、いわゆる一般的なObject からの継承を断ち切っている。また、Application の mixin は、uberproto ライブラリを用いて行なっている。アプリケーションの核は、mixin した Application であり、これは require(&#39;./application&#39;) したものである。$ less feathers/lib/application.jsconst application = { init () { Object.assign(this, { version, methods: [ &#39;find&#39;, &#39;get&#39;, &#39;create&#39;, &#39;update&#39;, &#39;patch&#39;, &#39;remove&#39; ], mixins: [], services: {}, providers: [], _setup: false, settings: {} }); this.configure(hooks()); this.configure(events()); }, ......};module.exports = application;つまり、この application がアプリケーションの本体となる。空のオブジェクトに mixin された後、初期化するために呼び出される init() で、アプリケーションオブジェクトのプロパティーとなる methods や mixins、　 services などを設定し、フックやイベントの初期設定を行なっている。" }, { "title": "Enable Google Page Views", "url": "/doc/posts/enable-google-pv/", "categories": "Blogging, Tutorial", "tags": "google analytics, pageviews", "date": "2021-01-04 08:32:00 +0900", "snippet": "This post is to enable Page Views on the Chirpy theme based blog that you just built. This requires technical knowledge and it’s recommended to keep the google_analytics.pv.* empty unless you have a good reason. If your website has low traffic, the page views count would discourage you to write more blogs. With that said, let’s start with the setup.Set up Google AnalyticsCreate GA account and propertyFirst, you need to set up your account on Google analytics. While you create your account, you must create your first Property as well. Head to https://analytics.google.com/ and click on Start Measuring Enter your desired Account Name and choose the desired checkboxes Enter your desired Property Name. This is the name of the tracker project that appears on your Google Analytics dashboard Enter the required information About your business Hit Create and accept any license popup to set up your Google Analytics account and create your propertyCreate Data StreamWith your property created, you now need to set up Data Stream to track your blog traffic. After you signup, the prompt should automatically take you to create your first Data Stream. If not, follow these steps: Go to Admin on the left column Select the desired property from the drop-down on the second column Click on Data Streams Add a stream and click on Web Enter your blog’s URLIt should look like this:Now, click on the new data stream and grab the Measurement ID. It should look something like G-V6XXXXXXXX. Copy this to your _config.yml filegoogle_analytics: id: &#39;G-V6XXXXXXX&#39; # fill in your Google Analytics ID # Google Analytics pageviews report settings pv: proxy_endpoint: # fill in the Google Analytics superProxy endpoint of Google App Engine cache_path: # the local PV cache data, friendly to visitors from GFW regionWhen you push these changes to your blog, you should start seeing the traffic on your Google Analytics. Play around with the Google Analytics dashboard to get familiar with the options available as it takes like 5 mins to pick up your changes. You should now be able to monitor your traffic in real time.Setup Page ViewsThere is a detailed tutorial available to set up Google Analytics superProxy. But, if you are interested to just quickly get your Chirpy-based blog display page views, follow along. These steps were tested on a Linux machine. If you are running Windows, you can use the Git bash terminal to run Unix-like commands.Setup Google App Engine Visit https://console.cloud.google.com/appengine Click on Create Application Click on Create Project Enter the name and choose the data center close to you Select Python language and Standard environment Enable billing account. Yeah, you have to link your credit card. But, you won’t be billed unless you exceed your free quota. For a simple blog, the free quota is more than sufficient. Go to your App Engine dashboard on your browser and select API &amp;amp; Services from the left navigation menu Click on Enable APIs and Services button on the top Enable the following APIs: Google Analytics API On the left, Click on OAuth Consent Screen and accept Configure Consent Screen. Select External since your blog is probably hosted for the public. Click on Publish under Publishing Status Click on Credentials on the left and create a new OAuth Client IDs credential. Make sure to add an entry under Authorized redirect URIs that matches: https://&amp;lt;project-id&amp;gt;.&amp;lt;region&amp;gt;.r.appspot.com/admin/auth Note down the Your Client ID and Your Client Secret. You’ll need this in the next section. Download and install the cloud SDK for your platform: https://cloud.google.com/sdk/docs/quickstart Run the following commands: [root@bc96abf71ef8 /]# gcloud init~snip~Go to the following link in your browser: https://accounts.google.com/o/oauth2/auth?response_type=code&amp;amp;client_id=XYZ.apps.googleusercontent.com&amp;amp;redirect_uri=ABCDEFGEnter verification code: &amp;lt;VERIFICATION CODE THAT YOU GET AFTER YOU VISIT AND AUTHENTICATE FROM THE ABOVE LINK&amp;gt;You are logged in as: [blah_blah@gmail.com].Pick cloud project to use:[1] chirpy-test-300716[2] Create a new projectPlease enter numeric choice or text value (must exactly match listitem): 1[root@bc96abf71ef8 /]# gcloud info# Your selected project info should be displayed here Setup Google Analytics superProxy Clone the Google Analytics superProxy project on Github: https://github.com/googleanalytics/google-analytics-super-proxy to your local. Remove the first 2 lines in the src/app.yaml file: - application: your-project-id- version: 1 In src/config.py, add the OAUTH_CLIENT_ID and OAUTH_CLIENT_SECRET that you gathered from your App Engine Dashboard. Enter any random key for XSRF_KEY, your config.py should look similar to this #!/usr/bin/python2.7__author__ = &#39;pete.frisella@gmail.com (Pete Frisella)&#39;# OAuth 2.0 Client SettingsAUTH_CONFIG = { &#39;OAUTH_CLIENT_ID&#39;: &#39;YOUR_CLIENT_ID&#39;, &#39;OAUTH_CLIENT_SECRET&#39;: &#39;YOUR_CLIENT_SECRET&#39;, &#39;OAUTH_REDIRECT_URI&#39;: &#39;%s%s&#39; % ( &#39;https://chirpy-test-XXXXXX.ue.r.appspot.com&#39;, &#39;/admin/auth&#39; )}# XSRF SettingsXSRF_KEY = &#39;OnceUponATimeThereLivedALegend&#39; Tip: You can configure a custom domain instead of https://PROJECT_ID.REGION_ID.r.appspot.com. But, for the sake of keeping it simple, we will be using the Google provided default URL. From inside the src/ directory, deploy the app [root@bc96abf71ef8 src]# gcloud app deployServices to deploy:descriptor: [/tmp/google-analytics-super-proxy/src/app.yaml]source: [/tmp/google-analytics-super-proxy/src]target project: [chirpy-test-XXXX]target service: [default]target version: [VESRION_NUM]target url: [https://chirpy-test-XXXX.ue.r.appspot.com]Do you want to continue (Y/n)? YBeginning deployment of service [default]...╔════════════════════════════════════════════════════════════╗╠═ Uploading 1 file to Google Cloud Storage ═╣╚════════════════════════════════════════════════════════════╝File upload done.Updating service [default]...done.Setting traffic split for service [default]...done.Deployed service [default] to [https://chirpy-test-XXXX.ue.r.appspot.com]You can stream logs from the command line by running:$ gcloud app logs tail -s defaultTo view your application in the web browser run:$ gcloud app browse Visit the deployed service. Add a /admin to the end of the URL. Click on Authorize Users and make sure to add yourself as a managed user. If you get any errors, please Google it. The errors are self-explanatory and should be easy to fix. If everything went good, you’ll get this screen:Create Google Analytics QueryHead to https://PROJECT_ID.REGION_ID.r.appspot.com/admin and create a query after verifying the account. GA Core Reporting API query request can be created in Query Explorer.The query parameters are as follows: start-date: fill in the first day of blog posting end-date: fill in today (this is a parameter supported by GA Report, which means that it will always end according to the current query date) metrics: select ga:pageviews dimensions: select ga:pagePathIn order to reduce the returned results and reduce the network bandwidth, we add custom filtering rules 1: filters: fill in ga:pagePath=~^/posts/.*/$;ga:pagePath!@=. Among them, ; means using logical AND to concatenate two rules. If the site.baseurl is specified, change the first filtering rule to ga:pagePath=~^/BASE_URL/posts/.*/$, where BASE_URL is the value of site.baseurl. After Run Query, copy the generated contents of API Query URI at the bottom of the page and fill in the Encoded URI for the query of SuperProxy on GAE.After the query is saved on GAE, a Public Endpoint (public access address) will be generated, and we will get the query result in JSON format when accessing it. Finally, click Enable Endpoint in Public Request Endpoint to make the query effective, and click Start Scheduling in Scheduling to start the scheduled task.Configure Chirpy to Display Page ViewOnce all the hard part is done, it is very easy to enable the Page View on Chirpy theme. Your superProxy dashboard should look something like below and you can grab the required values.Update the _config.yml file of Chirpy project with the values from your dashboard, to look similar to the following:google_analytics: id: &#39;G-V6XXXXXXX&#39; # fill in your Google Analytics ID pv: proxy_endpoint: &#39;https://PROJECT_ID.REGION_ID.r.appspot.com/query?id=&amp;lt;ID FROM SUPER PROXY&amp;gt;&#39; cache_path: # the local PV cache data, friendly to visitors from GFW regionNow, you should see the Page View enabled on your blog.Reference Google Analytics Core Reporting API: Filters &amp;#8617; " } ]
